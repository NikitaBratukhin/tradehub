<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TradeHub{% endblock %}</title>
    {% load static %}
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –∏ —à—Ä–∏—Ñ—Ç—ã -->
    <link rel="stylesheet" href="{% static 'app/css/styles.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="{% url 'home' %}">TradeHub</a>
            </div>

            {% if user.is_authenticated %}
            <div class="nav-user">
                <div class="notification-bell" id="notification-bell" aria-haspopup="true" aria-expanded="false">
                    <button id="notification-button" class="bell-button" aria-label="–û—Ç–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                        <span class="bell-icon">üîî</span>
                        <span class="notification-count" id="notification-count" style="display: none;">0</span>
                    </button>

                    <div class="notification-dropdown" id="notification-dropdown" aria-hidden="true">
                        <div class="notification-header">
                            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            <a href="{% url 'notifications' %}" class="small-link">–í—Å–µ</a>
                        </div>
                        <div id="notification-list">
                            <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ JS -->
                        </div>
                        <div class="notification-footer">
                            <a href="{% url 'notifications' %}">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</a>
                        </div>
                    </div>
                </div>

                <a href="{% url 'profile' %}" class="nav-link user-profile-link" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <div class="author-avatar small-avatar">{{ user.username|first|upper }}</div>
                    <span>@{{ user.username }}</span>
                </a>

                <a href="{% url 'menu' %}" class="nav-btn-icon" title="–ú–µ–Ω—é">‚ò∞</a>
                <a href="{% url 'logout' %}" class="nav-link" title="–í—ã–π—Ç–∏">–í—ã–π—Ç–∏</a>
            </div>
            {% else %}
            <div class="nav-auth">
                <a href="{% url 'login' %}" class="nav-btn">–í–æ–π—Ç–∏</a>
                <a href="{% url 'register' %}" class="nav-btn nav-btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
            {% endif %}
        </div>
    </nav>

    <main class="main-content">
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
                {% if 'welcome' not in message.tags %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <div id="welcome-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="close-welcome-modal" role="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</span>
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TradeHub!</h2>
            <p>–ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ. –ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–∞—à–∏–º–∏ –æ–±—É—á–∞—é—â–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏.</p>
            <a href="{% url 'education' %}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—É—á–µ–Ω–∏—é</a>
        </div>
    </div>

    {# –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º URL'—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ JS #}
    {% url 'get_notifications_api' as GET_NOTIFICATIONS_API_URL %}
    {% url 'api_unread_notifications_count' as UNREAD_NOTIFICATIONS_COUNT_API_URL %}
    {% url 'mark_notification_read_api' 0 as MARK_NOTIFICATION_READ_API_URL_BASE %}
    {% url 'toggle_boost_api' 0 as TOGGLE_BOOST_API_URL_BASE %}
    {% url 'publication_detail' 0 as PUBLICATION_DETAIL_URL_BASE %}
    {% url 'notifications' as NOTIFICATIONS_PAGE_URL %}
    {% url 'profile' as PROFILE_PAGE_URL %}
    {% url 'login' as LOGIN_URL %}
    {% url 'register' as REGISTER_URL %}
    {% url 'logout' as LOGOUT_URL %}
    {% url 'education' as EDUCATION_URL %}
    {% url 'home' as HOME_URL %}

    <script>
        // Define a global namespace and context variables safely
        window.TradeHub = window.TradeHub || {};

        // This prevents a syntax error if the template tag renders an empty string
        const USER_IS_AUTHENTICATED = "{{ user.is_authenticated|yesno:'true,false' }}" === 'true';

        // API endpoints and page URLs (escapejs for safety)
        const NOTIFICATIONS_API_URL = "{{ GET_NOTIFICATIONS_API_URL|escapejs }}";
        const UNREAD_NOTIFICATIONS_COUNT_API_URL = "{{ UNREAD_NOTIFICATIONS_COUNT_API_URL|escapejs }}";
        // MARK_NOTIFICATION_READ_API_URL_BASE contains a URL with pk=0, e.g. "/api/notifications/mark-read/0/"
        const MARK_NOTIFICATION_READ_API_URL_BASE = "{{ MARK_NOTIFICATION_READ_API_URL_BASE|escapejs }}";
        // TOGGLE_BOOST_API_URL_BASE contains a URL with pk=0, e.g. "/api/toggle-boost/0/"
        const TOGGLE_BOOST_API_URL_BASE = "{{ TOGGLE_BOOST_API_URL_BASE|escapejs }}";
        // Base URL to open a publication detail (pk=0 -> replace 0 with actual id in JS)
        const PUBLICATION_DETAIL_URL_BASE = "{{ PUBLICATION_DETAIL_URL_BASE|escapejs }}";

        const NOTIFICATIONS_PAGE_URL = "{{ NOTIFICATIONS_PAGE_URL|escapejs }}";
        const PROFILE_PAGE_URL = "{{ PROFILE_PAGE_URL|escapejs }}";
        const LOGIN_URL = "{{ LOGIN_URL|escapejs }}";
        const REGISTER_URL = "{{ REGISTER_URL|escapejs }}";
        const LOGOUT_URL = "{{ LOGOUT_URL|escapejs }}";
        const EDUCATION_URL = "{{ EDUCATION_URL|escapejs }}";
        const HOME_URL = "{{ HOME_URL|escapejs }}";

        // CSRF token (will be provided by Django)
        const CSRF_TOKEN = "{{ csrf_token|escapejs }}";
    </script>

    <script src="{% static 'app/js/main.js' %}"></script>

    {# –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–≥–æ–º 'welcome', –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ main.js #}
    {% for message in messages %}
        {% if 'welcome' in message.tags %}
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    if (window.TradeHub && typeof window.TradeHub.showWelcomeModal === 'function') {
                        TradeHub.showWelcomeModal();
                    } else {
                        // fallback: –ø–æ–∫–∞–∂–µ–º –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥–∞–ª –≤—Ä—É—á–Ω—É—é
                        const modal = document.getElementById('welcome-modal');
                        if (modal) modal.style.display = 'block';
                    }
                });
            </script>
        {% endif %}
    {% endfor %}
</body>
</html>
